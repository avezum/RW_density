---
title: "Distribution of portfolio credit risk and capital savings"
author:
- affiliation: Tilburg University; l.avezum@uvt.nl
  name: Lucas Avezum
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    citation_package: natbib
    latex_engine: pdflatex
    template: tex-ms.tex
  html_document:
    df_print: paged
  word_document: default
bibliography: null
citecolor: null
anonymous: no
fontsize: 12pt
geometry: margin= 1in
keywords: Key1, Key2, Key3
linkcolor: blue
biblio-style: apsr
subtitle: ''
thanks: Very preliminary draft
#abstract: 'In this paper, I study the possibility, allowed by regulation, for banks
#  to increase their capital ratio while maintaning the average portfolio riskiness. Basel II introduced
#  a concave mapping from probabilities of default to capital requiremets. As a consequence,
#  banks can reduce requirements or increase risk-taking by widening their portfolio
#  credit risk distribution.'
toc: no
urlcolor: null
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo      = FALSE, 
                      warning   = FALSE, 
                      error     = FALSE, 
                      tidy      = TRUE, 
                      tidy.opts = list(width.cutoff=50), 
                      collapse  = TRUE,
                      warning   = FALSE,
                      error     = FALSE,
                      message   = FALSE, 
                      comment   = "",
                      cache     = TRUE)
# These options are tuned for manuscript/presentation. 
# They basically run R in the background except for spitting out figures/tables
# They also cache results so that you don't have to run your whole analysis every time you fix a typo

rm(list = ls()) 

library(tidyverse)           ## Data manipulation, pipe operator
library(splitstackshape)     ## Command to expand data
library(data.table)          ## Command to bind lists
library(ggridges)            ## Density ridges plot
library(stargazer)           ## Latex tables
library(lfe)                 ## High-dimensional fixed effects
library(gridExtra)           ## Plot side-by-side
library(DescTools)           ## Command to winsorize variables
library(robustHD)

p_w <- c(0.01, 0.99)         ## Set winsorizing limits
```

```{r load data, include=TRUE}
load("../../Data/Datasets/Pillar3Data.Rda")
load("../../Data/Datasets/BankData.Rda")
load("../../Data/Datasets/CrossSectionDecomposition.Rda")
load("../../Data/Datasets/timedecomposition.Rda")
load("../../Data/Datasets/yeardecomposition.Rda")
load("../../Data/Datasets/DifInDif.Rda")
```

```{r change data, eval= FALSE, include=FALSE}
# Expand Pillar-III data frame to plot densities and lorenz curves
expanded.list <- list()
for(i in c("EAD","EL")) {
  expanded.list[[i]] <- pillar3.data %>%
  filter(Method2 %in% c("IRB")) %>%
  select(name,Country,Method,Portfolio_1,EAD,LGD,PD,year)%>%
  mutate(EL  = round(EAD*LGD/1000),
         EAD = round(EAD/1000))%>%
    na.omit(cols=c(i))%>%
    expandRows(i) %>%
    mutate(freq_type = as.factor(i))
}
pillar3.expanded <-  rbindlist(expanded.list, use.names=TRUE,fill = TRUE)


# Aggregate Pillar-III data by Portfolio
portfolio.data <- pillar3.data %>% 
  group_by(Country,Bank,year,Portfolio_1,Portfolio_2) %>%
  mutate(weight=EAD*LGD)%>%
  filter(weight>0, Portfolio_1 %in% c("Wholesale","Retail"))%>%
  dplyr::summarize(gini             = DescTools::Gini(PD,weight),
                   K_calculated     = sum(K_calculated),
                   K_counterfactual = sum(K_counterfactual)) %>%
  mutate(savings = (K_counterfactual-K_calculated)/K_counterfactual)


bank.data <- bank.data %>%
group_by(bvdid) %>% 
  mutate(savings_log  = log(K_counterfactual-K_calculated),
         Total.assets = Total.assets/10^6,
         Total.Capital= Total.Capital/10^6,
         Tier.1.Capital=Tier.1.Capital/10^6,
         asset_log    = log(Total.assets),
         capital_log  = log(Total.Capital),
         tier.1_log   = log(Tier.1.Capital),
         savings_rate = (K_counterfactual-K_calculated)/K_calculated,
         savings_alt  = (K_counterfactual-K_original)/K_original,
         error        = (K_calculated - K_original)/K_original,
         asset_d      = Winsorize(log(Total.assets)-lag(log(Total.assets),order_by=year), 
                                  probs = p_w ,na.rm = TRUE),
         capital_d    = Winsorize(log(Total.Capital)-lag(log(Total.Capital),order_by=year), 
                                  probs = p_w ,na.rm = TRUE),
         PD_mean_d    = Winsorize(PD_mean-lag(PD_mean,order_by=year), 
                                  probs = p_w ,na.rm = TRUE),
         savings_d    = Winsorize(savings_log-lag(savings_log,order_by=year), 
                                  probs = p_w ,na.rm = TRUE),
         car_d  = Winsorize(Total.Capital.Ratio/100-lag(Total.Capital.Ratio/100,order_by=year), 
                            probs = p_w ,na.rm = TRUE),
         roe_d  = Winsorize(ROE.using.P.L.before.tax..../100-lag(ROE.using.P.L.before.tax..../100,order_by=year),
                            probs = p_w ,na.rm = TRUE)) %>%
  ungroup()


test <- cross.section.decomposition %>% mutate(mean.total.gain = mean(total.gain,na.rm = TRUE)) %>%
  mutate_at(vars(SA.gain:total.gain),  funs((. - mean.total.gain)^2))%>%
summarize_at(vars(SA.gain:total.gain),  sum, na.rm =  TRUE)%>%
  mutate_all( funs((. / total.gain)))
```

```{r}

bank.data <- bank.data %>% ungroup() %>%
  mutate(RW.hat=RW.hat*100,
         RW.s=RW.s*100)
```

# List
* Use the share under IRB to weight capital savings measure (share vs intensity). Include share in regressions plus interaction with capital savings

* Explore alternative capital savings measures, such as, savings in terms of capital (mn),in terms of capital ratio, in terms of capital ratio savings (counterfactual vs actual)

* Plot marginal increase of savings in time. 

* Decompose capital savings: share effect, size effect, etc...

* Remove step effect from regressions: average across all IRB banks (add IRB dummy) or IRB specific dummy (average out the step for each bank). Idea is to focus on difference across IRB banks. it might not make sense to include SA banks anymore.

* Plot capital savings measures to other risk variables

* Plot cross section for different capital saving measures (replicate first plot)

* check and better clean data: 

# Capital savings measure

In this section I describe the chosen method to measure differences in risk distributions:

\begin{equation}
\text{Capital savings}_{i}= \frac{f(\overline{PD})\sum_{i}EAD_iLGD_i-\sum_{i}EAD_iLGD_if(PD_i)}{\sum_{i}EAD_i},
\end{equation}

where $i$ is one asset of the portfolio, $f()$ is the regulatory formula and, 

\begin{equation}
\overline{PD}=\frac{\sum_iEAD_iLGD_iPD_i}{\sum_iEAD_iLGD_i}.
\end{equation}


```{r}
savings_cap = "The figure plots the log of banks capital savings. This measure is calculated using equation 1. Each point in the plot is a bank-year observation."
```

```{r, fig.height = 5, fig.width = 5,results="hide",fig.cap= savings_cap,fig.align = 'center'}
bank.data %>% filter(!is.na(RW.s), IRB == 1) %>%
 ggplot(mapping = aes(x = reorder(name, RW.s, FUN = median, na.rm=TRUE),
                          y = RW.s,
                      color= Country, 
                      fill = Country)) +
geom_point(alpha = 0.5,size = 2) +
    labs(x=NULL) +
    coord_flip() +
  labs(y =  "Capital savings") +
  
  theme_bw()

```











```{r}
fig3_cap = "PD distribution by bank. The figure shows smoothed PD distributions for each bank in our data. Banks are ranked by median PD and colored by host-country"
```


```{r, fig.height = 10, fig.width = 7, eval=FALSE, include=FALSE, results="hide",fig.cap= fig3_cap,out.width = "1\\textwidth"}
pillar3.expanded %>% 
  filter( !is.na(PD),PD<100, freq_type%in%c("EL") ) %>% 
ggplot(aes(x = PD, y = reorder(name, PD,FUN = median, na.rm=TRUE),color=Country,fill=Country)) +
  stat_density_ridges(quantile_lines = TRUE, quantiles = 2, alpha = 0.6,
                       scale = 2 , from = 0, to = 0.05) +
  scale_x_continuous(expand = c(0.01, 0),labels = scales::percent) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(
    x = 'Probability of default') +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())
```




# Decomposition

\begin{equation}
\begin{aligned}
\Delta RW & = q_{B}^{SA} \Delta RW^{SA}+(1-q_{B}^{SA})\sum_{j=1}^{P} q_{B}^{j}\Delta \hat{RW}^{j} \\ 
& + (1-q_{B}^{SA})\sum_{j=1}^{P} \hat{RW}^{j} \Delta q^{j} -(1-q_{B}^{SA})\Delta RW^{S} + (RW^{SA}-RW^{IRB})\Delta q^{SA},
\end{aligned}
\end{equation}

\newpage
## Time decomposition 

```{r}
time.dec_cap = "Time decompostion. The figure shows the contribution of each component compared to the time of IRB introduction (t=0). The figure and calculations include only banks with observations for at least 5 consecutive years. The black line is the net change. Year decompostion. The figure shows the contribution of each component compared to 2008. The figure and calculations include all banks in the sample. The black line is the net change." 
```

```{r, fig.height = 4, fig.width = 7, results="hide",fig.cap= time.dec_cap,out.width = "1\\textwidth"}
time.lable <- c("t=0", "t=1", "t=2", "t=3", "t=4")
plot1 <-time.decomposition %>% 
  select(time, RW, t0.RW,  SA.gain, IRB.gain, mix.gain, dispersion.gain, rollout.gain) %>%
  gather(condition, value, contains(".gain"), factor_key=TRUE)%>%
  mutate(condition = relevel(condition,"dispersion.gain"),
         RW = RW - t0.RW,
         time = as.factor(time)) %>%
  ggplot(mapping = aes(x = time,
                       y    = value, 
                       fill = condition)) +
geom_bar(stat = 'identity')+
geom_line(aes(group=1, y = RW))  +
  labs( y = 'Change from t=0', subtitle = "Plot a" ) +
  scale_fill_discrete(labels = c("PD distribution effect", "SA effect", "IRB effect","Mix effect","Roll-out effect"), name = "Component")+
  scale_x_discrete( name=NULL,breaks = c("0","1","2","3","4"),labels = c("t=0","t=1","t=2","t=3","t=4")) +
 theme(legend.position = c(0.3, 0.2), 
        legend.title = element_blank(), 
        legend.background=element_blank())

year.decomposition <- year.decomposition %>%
  mutate(RW_2 = RW - t0.RW,
         year = as.factor(year)) 
plot2 <- year.decomposition %>% 
  select(year,RW,  SA.gain, IRB.gain, mix.gain, dispersion.gain, rollout.gain) %>%
  gather(condition, value, contains(".gain"), factor_key=TRUE)%>%
  mutate(condition = relevel(condition,"dispersion.gain")) %>%
  ggplot(mapping = aes(x = year)) +
geom_bar(aes(y = value, 
          fill = condition),
          stat = 'identity')+
geom_line(data = year.decomposition, 
          aes(group=1,y = RW_2))  +
  labs(y = 'Change from 2008', x=NULL, subtitle = "Plot b") +
  scale_fill_discrete(labels = c("PD distribution effect", "SA effect", "IRB effect","Mix effect","Roll-out effect"), name = "Component")+
  scale_x_discrete(breaks = c("2008","2010","2012","2014","2016","2018"))+
theme(legend.position='none')
grid.arrange(plot1, plot2, ncol=2)
    
```


\newpage

## Cross-section decomposition

```{r}
cross.dec_cap = "Cross-section decompostion. The figure shows the contribution of each component compared to the average bank. The figure and calculations include all banks in the sample. The black line is the total RW. Relative cross-section decompostion. The figure shows the relative contribution of each component compared to the average bank. The figure and calculations include all banks in the sample. " 
```

```{r, fig.height = 5, fig.width = 7, results="hide",fig.cap= cross.dec_cap,out.width = "1\\textwidth"}
plot1 <- cross.section.decomposition %>% 
  mutate(order.s = abs(dispersion.gain))%>%
  select(name, Country, total= total.gain, order.s, SA.gain, IRB.gain, mix.gain, dispersion.gain, rollout.gain) %>%
  gather(condition, value, contains(".gain"), factor_key=TRUE)%>%
  mutate(condition = relevel(condition,"dispersion.gain")) %>%
  ggplot(mapping = aes(x = reorder(name, order.s),
                       y = value, fill = condition)) +
geom_bar(stat = 'identity')+
  geom_line(aes(y = total,group=1))  +
  labs(x=NULL, y= NULL,subtitle = "Plot a") +
    coord_flip() +
  scale_fill_discrete(labels = c("PD distribution effect", "SA effect", "IRB effect","Mix effect","Roll-out effect"), name = "Component")+
 theme(legend.position='none')

plot2 <- cross.section.decomposition %>% 
  mutate(order.s = abs(dispersion.gain))%>%
  select(name, Country, order.s, SA.gain, IRB.gain, mix.gain, dispersion.gain, rollout.gain) %>%
  gather(condition, value, contains(".gain"), factor_key=TRUE)%>%
  mutate(value = abs(value),
         condition = relevel(condition,"dispersion.gain")) %>%
  ggplot(mapping = aes(x = reorder(name, order.s),
                       y = value, fill = condition)) +
geom_bar(stat = 'identity',position = "fill")+
  labs(x=NULL, y= NULL,subtitle = "Plot b") +
    coord_flip() +
  scale_fill_discrete(labels = c("PD distribution effect", "SA effect", "IRB effect","Mix effect","Roll-out effect"), name = "Component")+
   theme(legend.title = element_blank(), 
        legend.background=element_blank(),
       legend.text=element_text(size=7),
       axis.text.y = element_blank())

grid.arrange(plot1, plot2, ncol=2)
  
  
```



# Counterfactual analysis

```{r}
tier1_cap = "The figure shows scatter plots and the linear relationship between the capital savings measure and capital ratios. The y-axis variable on plots a and b is the tier 1 capital ratio, and on plots c and d is the total capital ratio. Plots a and c plots all data points in the sample. Plots b and d plots the average across time for bank using the IRB approach."
```

```{r , fig.height = 6, fig.width = 7, results="hide",fig.cap= tier1_cap,out.width = "1\\textwidth"}
 plot1 <- bank.data %>%  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>% 
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  select(name,RW.s, tier1ratio, tier.hat, IRB) %>%
  gather(condition, value, tier1ratio:tier.hat, factor_key=TRUE)  %>% 
 ggplot(mapping = aes(x = RW.s,
                      y = value,
                      color = condition,
                      fill = condition)) +
geom_point( alpha = 0.5,size = 1) +
  scale_y_continuous( limits=c(5, 20))+
  labs(x="",y="Tier 1 capital ratio", subtitle = "Plot a") +
  geom_smooth(method = "lm",color="black") +
  theme_bw()+
  scale_fill_discrete(labels = c("Actual", "Counterfactual"))+
  scale_color_discrete(labels = c("Actual", "Counterfactual")) +
theme(legend.position='none')

plot2 <- bank.data %>%  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>% mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  select(name,RW.s, tier1ratio, tier.hat, IRB) %>%
  filter(!is.na(RW.s), IRB == 1) %>%
  group_by(name)%>%
 summarise_if(is.numeric,funs(mean),na.rm=TRUE)%>%
  gather(condition, value, tier1ratio:tier.hat, factor_key=TRUE)  %>%
 ggplot(mapping = aes(x = RW.s,
                      y = value,
                      color = condition,
                      fill = condition)) +
geom_point( alpha = 0.5,size = 1) +
  scale_y_continuous( limits=c(5, 20))+
  labs(x="",y="",subtitle = "Plot b") +
  geom_smooth(method = "lm",color="black") +
  theme_bw()+
  scale_fill_discrete(labels = c("Actual", "Counterfactual"), name = "Tier 1 ratio")+
  scale_color_discrete(labels = c("Actual", "Counterfactual"), name = "Tier 1 ratio")+
  theme(legend.position = c(0.8, 0.85), 
        legend.title = element_blank(), 
        legend.background=element_blank())
 
 
plot3 <- bank.data %>%  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>% mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  select(name,RW.s, totalcapitalratio, CAR.hat, IRB) %>%
  gather(condition, value, totalcapitalratio:CAR.hat, factor_key=TRUE)%>%
 ggplot(mapping = aes(x = RW.s,
                      y = value,
                      color = condition,
                      fill = condition)) +
geom_point( alpha = 0.5,size = 1) +
  scale_y_continuous( limits=c(5, 20))+
  labs(x="Capital savings",y="Total capital ratio", subtitle = "Plot c") +
  geom_smooth(method = "lm",color="black") +
  theme_bw()+
  scale_color_discrete(labels = c("Actual", "Counterfactual"), name = "Total capital ratio")+
  scale_fill_discrete(labels = c("Actual", "Counterfactual"), name = "Total capital ratio")+
  theme(legend.position='none')

plot4 <- bank.data %>% filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>% mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  select(name,RW.s, totalcapitalratio, CAR.hat, IRB) %>%
  filter(!is.na(RW.s), IRB == 1) %>%
  group_by(name)%>%
 summarise_if(is.numeric,funs(mean),na.rm=TRUE)%>%
  gather(condition, value, totalcapitalratio:CAR.hat, factor_key=TRUE)%>%
 ggplot(mapping = aes(x = RW.s,
                      y = value,
                      color = condition,
                      fill = condition)) +
geom_point( alpha = 0.5,size = 1) +
  scale_y_continuous( limits=c(5, 20))+
  labs(x="Capital savings",y="",  subtitle = "Plot d") +
  geom_smooth(method = "lm",color="black") +
  theme_bw()+
  scale_color_discrete(labels = c("Actual", "Counterfactual"), name = "Total capital ratio")+
  scale_fill_discrete(labels = c("Actual", "Counterfactual"), name = "Total capital ratio")+
  theme(legend.position='none')

grid.arrange(plot1, plot2, plot3, plot4, ncol=2)
```



```{r , fig.height = 10, fig.width = 7, results="asis",out.width = "1\\textwidth"}
bank.data %>% ungroup()%>%
  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>%
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE)%>%
  subset(select = c("RW.s","tier1ratio","tier.hat","totalcapitalratio","CAR.hat","ROE","Zscore")) %>%
  as.data.frame() %>% 
stargazer(header = FALSE, type="latex", single.row = TRUE, column.sep.width = "1pt", font.size = "small",
          omit.summary.stat = c("p25","p75"),
          covariate.labels = c("Capital savings","Tier 1 ratio","Counterfactual tier 1 ratio","Total ratio","Counterfactual total ratio","ROE","Z-score"),
          title = "Summary statistics",
          table.layout = "n=d#-t-as-",
          notes = "\\parbox[t]{11cm}{The table shows summary statistics for the sample of banks collected. Capital savings, Portfolio mean PD and, Gini coefficient were calculated using the collected information from Pillar-3 reports. The remaining variables come from BankFocus.}", 
          notes.label = "",
          notes.align = "c", 
          notes.append = FALSE)
``` 


```{r}
fig2_cap = "The figure plots the evolution in time of Capital savings, Tier 1 capital ratio and, ROE. The solid line is the average across banks for each year. The first and third quartiles are shown in the gray area."
```

```{r, fig.height = 3, fig.width = 7, results="hide",fig.cap= fig2_cap,out.width = "1\\textwidth", eval=FALSE, include=FALSE}
mean_cl_quantile <- function(x, q = c(0.25, 0.75), na.rm = TRUE){
  dat <- data.frame(y = mean(x, na.rm = TRUE),
                    ymin = quantile(x, probs = q[1], na.rm = na.rm),
                    ymax = quantile(x, probs = q[2], na.rm = na.rm))
  return(dat)
}

plot1 <- bank.data %>%
  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu) %>%
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  mutate(time = lubridate::ymd(year, truncated = 2L))%>% 
ggplot(aes(x=time)) +
 geom_smooth(aes( y=RW.s, color = RW.s),stat = 'summary', fun.data = mean_cl_quantile,color="black")+
labs(x="",y="",
     title = 'Capital savings') +
  theme_bw()

plot2 <- bank.data  %>%
  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu) %>%
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  mutate(time = lubridate::ymd(year, truncated = 2L))%>%
ggplot(aes(x=time)) +
   geom_smooth(aes(y=ROE, color = ROE),stat = 'summary', fun.data = mean_cl_quantile,color="black")+
labs(x="",y="",
     title = 'ROE') +
  theme_bw()

plot3 <- bank.data  %>%
  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>%
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) %>%
  mutate(time = lubridate::ymd(year, truncated = 2L))%>%
ggplot(aes(x=time)) +
   geom_smooth(aes(y=tier1ratio, color = tier1ratio ),stat = 'summary', fun.data = mean_cl_quantile,color="black")+
labs(x="",y="",
     title = 'Tier 1 ratio') +
  theme_bw()



grid.arrange(plot1, plot2, plot3, ncol=3)
```



```{r, include=FALSE}


DiD.data <- DiD.data %>% ungroup() %>% 
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) 
  
DiD.intensity <- felm(outcome ~ Shortfall.RW | Country |0|0,
                  data = DiD.data)

DiD.intensity.2 <- felm(outcome ~ Shortfall.RW.2 | Country |0|0,
                  data = DiD.data)

DiD.dummy <- felm(outcome ~ EBAbank | Country |0|0,
                  data = subset(DiD.data, subset = EBAcountry == 1))

```

```{r, fig.height = 10, fig.width = 7, results="asis", out.width = "1\\textwidth", cache = FALSE, warning=FALSE, message=FALSE}

stargazer( DiD.intensity.2, DiD.dummy,
          header = FALSE, type="latex", keep.stat = c("n","rsq"), font.size = "small",
          title = "EBA capital exercise and Capital Savings",
          table.layout = "n=d#-t-as-",
          notes = "\\parbox[t]{7cm}{The table shows the estimates for the following model: \\newline \\begin{equation*}\\text{Capital savings}_i = \\beta X_i+\\varepsilon_i. \\end{equation*} \\newline The dependent variable in each regression is the measure of capital savings. In column (1) the regressor is the capital shortfall during the capital exercise and in column (2) a dummy that indicates if bank $i$ was part of the exercise.}", 
          notes.label = "",
          notes.align = "c", 
          notes.append = FALSE,
          label = "",
          style = "qje",
          dep.var.labels = c("Capital savings"), column.sep.width = "2pt",
          covariate.labels = c( "Shortfall","EBA dummy"),
          add.lines = list(c("Country FE","Yes","Yes")))



```   




```{r, echo=FALSE}


bank.data <- bank.data %>% ungroup()%>%
  filter(!is.na(RW.s),
         !is.na(basel),
         tier1capitalmillcu < totalcapitalmillcu)%>%
  mutate_if(is.numeric,Winsorize,probs = p_w ,na.rm = TRUE) 

stage1 <- felm(data = bank.data , RW.s ~ basel + IRB  |  year +bvdid  |0|0)
se.s1 <- summary(stage1, robust=TRUE)$coefficients[,2]

bank.data <- mutate(bank.data, f.RW.s = stage1$fitted.values )

iv.t1 <- felm(data = bank.data ,tier1ratio  ~ f.RW.s  | year + bvdid|0|0)
#se.s1 <- summary(iv.t1$stage1,robust=TRUE)$coefficients[,2]
se.iv.t1 <- summary(iv.t1,robust=TRUE)$coefficients[,2]

iv.roe <- felm(data = bank.data ,ROE  ~ f.RW.s  | year + bvdid|0|0)
se.iv.roe <- summary(iv.roe,robust=TRUE)$coefficients[,2]

iv.z <- felm(data = bank.data , Zscore  ~ f.RW.s  | year + bvdid|0|0)
se.iv.z <- summary(iv.z,robust=TRUE)$coefficients[,2]

iv.roa <- felm(data = bank.data , ROA  ~ f.RW.s  | year + bvdid|0|0)
se.iv.roa <- summary(iv.roa,robust=TRUE)$coefficients[,2]

iv.sroa <- felm(data = bank.data , r.sd.ROA  ~ f.RW.s  | year + bvdid|0|0)
se.iv.sroa <- summary(iv.sroa,robust=TRUE)$coefficients[,2]

iv.lev <- felm(data = bank.data , leverage  ~ f.RW.s  | year + bvdid|0|0)
se.iv.lev <- summary(iv.lev,robust=TRUE)$coefficients[,2]

F.test <- round(t(sapply(stage1$lhs, function(lh) waldtest(stage1, ~ basel + IRB, lhs=lh)))[,5],1)



F.test <- c("F-test",as.character(F.test),"","","","","","","")

```

```{r,eval=TRUE, echo=FALSE, results='asis', warning=FALSE, message=FALSE}


stargazer(stage1, iv.t1, iv.roe, iv.roa, iv.z, iv.sroa, iv.lev, 
           header = FALSE, type="latex", keep.stat = c("n","rsq"), font.size = "small",
          title = "Instrumental variable analysis",
          table.layout = "n=c=d#-t-as-",
          notes = "\\parbox[t]{15cm}{The table shows the relationship between the measure of capital savings and several outcome variables instrumented by the introduction of Basel (at country level) and IRB (at bank level).}",
          se = list(se.s1, se.iv.t1, se.iv.roe, se.iv.z, se.iv.roa, se.iv.sroa, se.iv.lev),
          covariate.labels = c("Basel","IRB","Savings"),
          dep.var.labels = c("Savings","CET1","ROE","ROA", "Z-score", "sd(ROA)","Leverage"), 
          notes.label = "",
          notes.align = "c", 
          notes.append = FALSE,
          label = "",
          style = "qje",
          column.labels   = c("First stage", "Second stage"), 
          column.separate = c(1, 6),
          column.sep.width = "3pt",
          add.lines = list(c("Bank FE", "Yes", "Yes","Yes", "Yes", "Yes", "Yes", "Yes"),
                           c("Year FE", "Yes", "Yes","Yes", "Yes", "Yes", "Yes", "Yes"),
                           F.test))

```
```{r, echo=FALSE, include=FALSE}

reg.hdfe1 <- felm(tier1ratio  ~ RW.s | 0  |0|0,
                  data = bank.data)

reg.hdfe2 <- felm(tier1ratio  ~ RW.s  | bvdid + year  |0|0,
                  data = bank.data)


reg.hdfe3 <- felm(Zscore  ~ RW.s  | 0  |0|0,
                  data = bank.data)

reg.hdfe4 <- felm(Zscore  ~ RW.s  | bvdid + year  |0|0,
                  data = bank.data)

```


```{r, fig.height = 10, fig.width = 7, results="asis", out.width = "1\\textwidth", cache = FALSE, warning=FALSE, message=FALSE, include=FALSE, eval=FALSE}

stargazer(reg.hdfe1,reg.hdfe2,reg.hdfe3,reg.hdfe4,
          header = FALSE, type="latex", keep.stat = c("n","rsq"), font.size = "small",
          title = "Capital Savings and Capital Requirement Ratio",
          table.layout = "n=d#-t-as-",
          notes = "\\parbox[t]{10cm}{The table shows the relationship between the measure of capital savings and risk-weighted capital ratio. The dependent variable in each regression is the Core Tier 1 ratio. In column (2) and (3) I control for asset size, tier one capital size, and mean PD. In regressions (3) I also include bank and year fixed effects.}", 
          notes.label = "",
          notes.align = "c", 
          notes.append = FALSE,
          label = "",
          style = "qje",
          dep.var.labels = c("CT1 ratio"), column.sep.width = "2pt",
          add.lines = list(c("Year FE", "No", "No","Yes"),
                           c("Bank FE","No", "No","Yes")))



```   





